from os import popen
import hashlib
from os import listdir


#Grabbing exif propieties:   |lun ago 31 23:55:56 -05 2020|
def timestamp(file):
    data = popen('exiftool {} |grep "Time Stamp"'.format(file)).read().replace("Time Stamp","").replace("\n","").replace(" ","").replace("," , "")
    if(len(data)< 2):
        data = "None"
    return(data)


def company_name(file):
    data = popen('exiftool {} |grep "Company Name "'.format(file)).read().replace("Company Name","").replace("\n","").replace(" ","")
    if(len(data)< 2):
        data = "None"
    return(data)


def language_code(file):
    data = popen('exiftool {} |grep "Language Code"'.format(file)).read().replace("Language Code","").replace("\n","").replace("," , "").replace(" ","")
    if(len(data)< 2):
        data = "None"
    return(data)


def filesize(file):
    data = popen('exiftool {} |grep "File Size"'.format(file)).read().replace("File Size","").replace("\n","").replace("," , "").replace(" ","")
    if(len(data)< 2):
        data = "None"
    return(data)


def grab_exif(file):
    time = timestamp(file)
    company = company_name(file)
    encoding = language_code(file)
    size = filesize(file)
    exif_data = [time, company , encoding , size  ]
    return(exif_data)



#calculating hash   |mar sep  1 00:47:01 -05 2020|
def hash_sha256(file):
    filename = file
    with open(filename,"rb") as f:
        bytes = f.read() # read entire file as bytes
        readable_hash = hashlib.sha256(bytes).hexdigest();
    return(readable_hash)

#the reason why i added md5 hash having sha256 hash is because virustotal works for md5   |mar sep  1 01:02:35 -05 2020|
def hash_md5(file):
    filename = file
    with open(filename,"rb") as f:
        bytes = f.read() # read entire file as bytes
        readable_hash = hashlib.md5(bytes).hexdigest();
    return(readable_hash)



#creating test csv:   |lun ago 31 23:57:18 -05 2020|
path = "../test_small_sample"
sample = listdir(path)


#csv indexing...(just one time) |mar sep  1 00:52:44 -05 2020|
file = open("malware_data.csv" , 'a')
file.write("creation_date,company_name,encoding_language,size,sha256_hash,md5_hash")
file.write("\n")
file.close()


#adding files....   |mar sep  1 00:54:20 -05 2020|
for i in sample:
    item = "{}/{}".format(path,i)
    time = timestamp(item)
    company = company_name(item)
    encoding = language_code(item)
    size = filesize(item)
    sha256 = hash_sha256(item)
    md5 = hash_md5(item)
    exif = "{},{}.{},{},{},{}".format(time,company , encoding ,size, sha256, md5)
    #saving data inside CSV file   |mar sep  1 00:39:53 -05 2020|
    file = open("malware_data.csv" , 'a')
    file.write(exif)
    file.write("\n")
    print(exif,"saved")
    file.close()




